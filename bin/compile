#!/bin/bash

BUILD_DIR=$1
CACHE_DIR=$2

IMAGEMAGICK_REPO="https://github.com/ImageMagick/ImageMagick.git"
INSTALL_DIR="/app/imagemagick"  # Correct install path inside the app container

# Ensure the directory exists
echo "Creating install directory at $INSTALL_DIR..."
mkdir -p ${INSTALL_DIR}

# Install dependencies
echo "Installing dependencies..."
apt-get update
apt install -y build-essential libltdl-dev libjpeg-dev libpng-dev \
               libtiff-dev libwebp-dev libgif-dev libfreetype6-dev \
               liblcms2-dev libxml2-dev ghostscript libheif-dev libbmp-dev

# Clone the ImageMagick repository and checkout the desired version
echo "Cloning ImageMagick repository..."
git clone ${IMAGEMAGICK_REPO} /tmp/imagemagick
cd /tmp/imagemagick

# Configure ImageMagick to install to the local directory
echo "Configuring ImageMagick..."
./configure --prefix=${INSTALL_DIR} --with-heic=yes --with-modules \
            --enable-delegate-build --with-webp=yes --with-bmp=yes --with-heif=yes

# Build ImageMagick
echo "Building ImageMagick..."
make
make install

# Clean up
cd /
rm -rf /tmp/imagemagick

# Update environment variables to include local installation directories
echo "Updating environment variables..."
echo "export PATH=${INSTALL_DIR}/bin:\$PATH" >> $BUILD_DIR/.profile
echo "export LD_LIBRARY_PATH=${INSTALL_DIR}/lib:\$LD_LIBRARY_PATH" >> $BUILD_DIR/.profile
echo "export MAGICK_HOME=${INSTALL_DIR}" >> $BUILD_DIR/.profile

# Ensure .profile is sourced to apply changes
echo "Sourcing .profile to apply environment changes..."
source $BUILD_DIR/.profile

# Verify the installation by checking the magick version
echo "Verifying installation..."
magick --version

echo "ImageMagick installed successfully with HEIC, WebP, and BMP support in /app/imagemagick!"
