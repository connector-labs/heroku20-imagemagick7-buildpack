#!/bin/bash

BUILD_DIR=$1
CACHE_DIR=$2

APP_CHECKOUT_DIR=/app

# Create a local directory for FFmpeg
FFMPEG_DIR=$BUILD_DIR/ffmpeg

# Download FFmpeg precompiled binaries
echo "Downloading FFmpeg binaries..."
mkdir -p $FFMPEG_DIR
wget https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-i686-static.tar.xz -P $FFMPEG_DIR

# Extract FFmpeg binaries
echo "Extracting FFmpeg..."
tar -xvf $FFMPEG_DIR/ffmpeg-release-i686-static.tar.xz -C $FFMPEG_DIR

# List extracted files for debug
echo "Listing extracted files:"
ls -l $FFMPEG_DIR/ffmpeg-7.0.2-i686-static

# Add FFmpeg to the PATH for this session
echo "Adding FFmpeg to PATH..."
export PATH=$FFMPEG_DIR/ffmpeg-7.0.2-i686-static:$PATH

# Debug the PATH to check if the folder was added
echo "Current PATH: $PATH"

# Check if ffmpeg is found by which
echo "Checking if ffmpeg is in PATH using 'which ffmpeg'..."
which ffmpeg

#
# Environment
#
# Add an export of PATH which includes our compile dir, etc.
echo "-----> Adding PATH environment"
mkdir -p "$APP_CHECKOUT_DIR"/.profile.d
cat > "$APP_CHECKOUT_DIR"/.profile.d/ffmpeg-path.sh <<EOF
  #!/bin/sh
  export PATH=$FFMPEG_DIR/ffmpeg-7.0.2-i686-static:$PATH
EOF

# Use full path to check ffmpeg functionality
FFMPEG_BIN=$FFMPEG_DIR/ffmpeg-7.0.2-i686-static/ffmpeg
echo "Using full path to check FFmpeg version..."
$FFMPEG_BIN -version